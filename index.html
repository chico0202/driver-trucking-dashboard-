<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø§Ù†Ø§ Ù…ÙˆØªÙˆ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f6fa; padding: 20px; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .live-data {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .driver-item, .trip-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .driver-item:hover, .trip-item:hover {
            background: #f8f9fa;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border-right: 4px solid #4a69bd;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        button {
            background: #4a69bd;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #1e3799;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }
        
        .status-online { background: #2ecc71; }
        .status-busy { background: #f39c12; }
        .status-offline { background: #e74c3c; }
        
        .control-panel {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .last-update {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        #connectionStatus {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #2ecc71;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¨Ø§Ù†Ø§ Ù…ÙˆØªÙˆ</h1>
        <p>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆØ§Ù„Ø±Ø­Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</p>
        <div id="lastUpdateTime" style="font-size:14px; opacity:0.9;">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: --</div>
    </div>
    
    <div class="control-panel">
        <button onclick="checkForUpdates()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>
        <button onclick="clearOldData()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©</button>
        <button onclick="testNotification()">ğŸ”” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
        <button onclick="window.open('https://chico0202.github.io/BANAMOTO123/', '_blank')">ğŸš— ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <div>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†</div>
            <div class="stat-value" id="connectedDrivers">0</div>
        </div>
        <div class="stat-card">
            <div>Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
            <div class="stat-value" id="activeTrips">0</div>
        </div>
        <div class="stat-card">
            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div>
            <div class="stat-value" id="totalEarnings">0 Ø¯.Øª</div>
        </div>
        <div class="stat-card">
            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª</div>
            <div class="stat-value" id="totalTrips">0</div>
        </div>
    </div>
    
    <div class="live-data">
        <h3>ğŸš— Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ† Ø§Ù„Ø¢Ù†</h3>
        <div id="driverList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
    
    <div class="live-data">
        <h3>ğŸ“ Ø¢Ø®Ø± Ø§Ù„Ø±Ø­Ù„Ø§Øª</h3>
        <div id="tripsList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
    
    <div id="connectionStatus">ğŸ”— Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØªØ¨Ø¹...</div>
    
    <div id="notifications"></div>

    <script>
        // ================= DASHBOARD CODE =================
        
        let drivers = [];
        let trips = [];
        let totalEarnings = 0;
        let updateInterval;
        let isConnected = false;
        
        // Start monitoring
        function startMonitoring() {
            console.log('ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØªØ¹Ù…Ù„');
            updateConnectionStatus(true);
            
            // Check for updates every 2 seconds
            updateInterval = setInterval(checkForUpdates, 2000);
            
            // Initial check
            checkForUpdates();
            
            // Load saved data
            loadSavedData();
            
            // Check URL for data (if driver shared a link)
            checkURLForData();
        }
        
        // Check for driver updates
        function checkForUpdates() {
            try {
                // Method 1: Check localStorage for last update
                const lastUpdate = localStorage.getItem('banamoto_last_update');
                
                if (lastUpdate) {
                    const update = JSON.parse(lastUpdate);
                    processDriverUpdate(update);
                    
                    // Clear it after processing (optional)
                    // localStorage.removeItem('banamoto_last_update');
                }
                
                // Method 2: Check all updates
                const allUpdates = localStorage.getItem('banamoto_all_updates');
                if (allUpdates) {
                    const updates = JSON.parse(allUpdates);
                    updates.forEach(update => {
                        if (!drivers.find(d => d.id === update.driverId && d.lastUpdate === update.timestamp)) {
                            processDriverUpdate(update);
                        }
                    });
                }
                
                // Update display
                updateDisplay();
                
                // Update timestamp
                document.getElementById('lastUpdateTime').textContent = 
                    'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', error);
                updateConnectionStatus(false);
            }
        }
        
        // Process driver update
        function processDriverUpdate(update) {
            console.log('ğŸ“¥ ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚:', update);
            
            // Show notification
            showNotification(getUpdateMessage(update));
            
            // Update drivers list
            const existingDriverIndex = drivers.findIndex(d => d.id === update.driverId);
            
            if (existingDriverIndex === -1) {
                // New driver
                drivers.push({
                    id: update.driverId,
                    name: update.driverName || update.driverId,
                    status: getStatusFromAction(update.action),
                    lastUpdate: update.timestamp,
                    lastAction: update.action,
                    data: update.data
                });
            } else {
                // Update existing driver
                drivers[existingDriverIndex].status = getStatusFromAction(update.action);
                drivers[existingDriverIndex].lastUpdate = update.timestamp;
                drivers[existingDriverIndex].lastAction = update.action;
                drivers[existingDriverIndex].data = update.data;
            }
            
            // Handle trip completion
            if (update.action === 'trip_completed') {
                trips.push({
                    id: 'trip_' + Date.now(),
                    driverId: update.driverId,
                    driverName: update.driverName,
                    distance: update.data.distance || 0,
                    price: update.data.price || 0,
                    time: update.timestamp,
                    displayTime: update.time || new Date().toLocaleTimeString()
                });
                
                // Add to total earnings
                totalEarnings += update.data.price || 0;
                
                // Save data
                saveData();
            }
            
            // If trip started
            if (update.action === 'trip_started') {
                // You could add to active trips list here
            }
        }
        
        // Get status from action
        function getStatusFromAction(action) {
            switch(action) {
                case 'driver_online':
                case 'driver_connected':
                    return 'online';
                case 'trip_started':
                    return 'busy';
                case 'trip_completed':
                    return 'online';
                case 'driver_reset':
                    return 'offline';
                default:
                    return 'online';
            }
        }
        
        // Get message for notification
        function getUpdateMessage(update) {
            const driverName = update.driverName || update.driverId;
            const time = update.time || new Date(update.timestamp).toLocaleTimeString();
            
            switch(update.action) {
                case 'driver_connected':
                    return `ğŸš— ${driverName} Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù…Ù†ØµØ©`;
                case 'driver_online':
                    return `âœ… ${driverName} Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±Ø­Ù„Ø§Øª`;
                case 'trip_started':
                    return `ğŸ¯ ${driverName} Ø¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© (${update.data.distance ? update.data.distance.toFixed(2) + ' ÙƒÙ…' : ''})`;
                case 'trip_completed':
                    return `ğŸ’° ${driverName} Ø£Ù†Ù‡Ù‰ Ø±Ø­Ù„Ø©: ${update.data.price ? update.data.price.toFixed(2) + ' Ø¯.Øª' : ''}`;
                case 'driver_reset':
                    return `ğŸ”„ ${driverName} Ø£Ø¹Ø§Ø¯ Ø§Ù„Ø¶Ø¨Ø·`;
                default:
                    return `ğŸ“± ${driverName}: ${update.action}`;
            }
        }
        
        // Show notification
        function showNotification(message) {
            const notifications = document.getElementById('notifications');
            const notificationId = 'notif_' + Date.now();
            
            const notification = document.createElement('div');
            notification.id = notificationId;
            notification.className = 'notification';
            notification.innerHTML = `
                <div style="font-size: 20px;">
                    ğŸ””
                </div>
                <div style="flex: 1;">
                    ${message}
                    <div class="last-update">${new Date().toLocaleTimeString()}</div>
                </div>
                <button onclick="document.getElementById('${notificationId}').remove()" style="
                    background: none;
                    border: none;
                    color: #666;
                    cursor: pointer;
                    font-size: 18px;
                    padding: 0;
                ">Ã—</button>
            `;
            
            notifications.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                const notif = document.getElementById(notificationId);
                if (notif) {
                    notif.style.opacity = '0';
                    notif.style.transform = 'translateX(100%)';
                    setTimeout(() => notif.remove(), 300);
                }
            }, 5000);
        }
        
        // Update display
        function updateDisplay() {
            // Update stats
            const onlineDrivers = drivers.filter(d => d.status === 'online' || d.status === 'busy').length;
            const busyDrivers = drivers.filter(d => d.status === 'busy').length;
            const totalTripsCount = trips.length;
            
            document.getElementById('connectedDrivers').textContent = onlineDrivers;
            document.getElementById('activeTrips').textContent = busyDrivers;
            document.getElementById('totalEarnings').textContent = totalEarnings.toFixed(2) + ' Ø¯.Øª';
            document.getElementById('totalTrips').textContent = totalTripsCount;
            
            // Update driver list
            updateDriverList();
            
            // Update trips list
            updateTripsList();
        }
        
        // Update driver list
        function updateDriverList() {
            const driverList = document.getElementById('driverList');
            
            if (drivers.length === 0) {
                driverList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØµÙ„ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                return;
            }
            
            // Sort by last update (newest first)
            const sortedDrivers = [...drivers].sort((a, b) => 
                new Date(b.lastUpdate) - new Date(a.lastUpdate)
            );
            
            let html = '';
            sortedDrivers.forEach(driver => {
                const statusClass = driver.status === 'online' ? 'status-online' : 
                                  driver.status === 'busy' ? 'status-busy' : 'status-offline';
                const statusText = driver.status === 'online' ? 'Ù…ØªØ§Ø­' : 
                                 driver.status === 'busy' ? 'ÙÙŠ Ø±Ø­Ù„Ø©' : 'ØºÙŠØ± Ù…ØªØµÙ„';
                const lastUpdate = new Date(driver.lastUpdate).toLocaleTimeString();
                
                html += `
                    <div class="driver-item">
                        <div>
                            <strong>${driver.name}</strong><br>
                            <small>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${driver.lastAction} (${lastUpdate})</small>
                            ${driver.data && driver.data.distance ? 
                                `<br><small>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${driver.data.distance.toFixed(2)} ÙƒÙ…</small>` : ''}
                            ${driver.data && driver.data.price ? 
                                `<br><small>Ø§Ù„Ø³Ø¹Ø±: ${driver.data.price.toFixed(2)} Ø¯.Øª</small>` : ''}
                        </div>
                        <div>
                            <span class="status-indicator ${statusClass}"></span>
                            ${statusText}
                        </div>
                    </div>
                `;
            });
            
            driverList.innerHTML = html;
        }
        
        // Update trips list
        function updateTripsList() {
            const tripsList = document.getElementById('tripsList');
            
            if (trips.length === 0) {
                tripsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>';
                return;
            }
            
            // Show last 10 trips
            const recentTrips = trips.slice(-10).reverse();
            
            let html = '';
            recentTrips.forEach(trip => {
                const time = new Date(trip.time).toLocaleTimeString();
                html += `
                    <div class="trip-item">
                        <div>
                            <strong>${trip.driverName}</strong><br>
                            <small>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${trip.distance ? trip.distance.toFixed(2) + ' ÙƒÙ…' : '--'}</small><br>
                            <small>Ø§Ù„Ø³Ø¹Ø±: ${trip.price ? trip.price.toFixed(2) + ' Ø¯.Øª' : '--'}</small>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            ${trip.displayTime || time}
                        </div>
                    </div>
                `;
            });
            
            tripsList.innerHTML = html;
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('banamoto_dashboard_drivers', JSON.stringify(drivers));
            localStorage.setItem('banamoto_dashboard_trips', JSON.stringify(trips));
            localStorage.setItem('banamoto_dashboard_earnings', totalEarnings);
        }
        
        // Load saved data
        function loadSavedData() {
            try {
                const savedDrivers = localStorage.getItem('banamoto_dashboard_drivers');
                const savedTrips = localStorage.getItem('banamoto_dashboard_trips');
                const savedEarnings = localStorage.getItem('banamoto_dashboard_earnings');
                
                if (savedDrivers) drivers = JSON.parse(savedDrivers);
                if (savedTrips) trips = JSON.parse(savedTrips);
                if (savedEarnings) totalEarnings = parseFloat(savedEarnings);
                
                updateDisplay();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }
        
        // Clear old data
        function clearOldData() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆÙ„ÙƒÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªØ¨Ù‚Ù‰.')) {
                // Keep only last 5 drivers and trips
                drivers = drivers.slice(-5);
                trips = trips.slice(-10);
                saveData();
                updateDisplay();
                showNotification('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©');
            }
        }
        
        // Test notification
        function testNotification() {
            showNotification('ğŸ”” Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            isConnected = connected;
            
            if (connected) {
                statusElement.innerHTML = 'âœ… Ù…ØªØµÙ„ - Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØªØ¨Ø¹';
                statusElement.style.background = '#2ecc71';
            } else {
                statusElement.innerHTML = 'âŒ ØºÙŠØ± Ù…ØªØµÙ„ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
                statusElement.style.background = '#e74c3c';
            }
        }
        
        // Check URL for shared data
        function checkURLForData() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('dashboardData');
            
            if (dataParam) {
                try {
                    const data = JSON.parse(decodeURIComponent(dataParam));
                    processDriverUpdate(data);
                    
                    // Clear URL parameter
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø·:', error);
                }
            }
        }
        
        // Start when page loads
        window.onload = function() {
            console.log('ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¬Ø§Ù‡Ø²Ø©');
            startMonitoring();
        };
        
        // Handle page visibility
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                checkForUpdates();
            }
        });
    </script>
</body>
</html>
